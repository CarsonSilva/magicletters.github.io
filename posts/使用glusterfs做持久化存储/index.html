<!DOCTYPE html>
<html lang="en-us"><head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="generator" content="Hugo 0.74.3" />
	
	<link rel="icon" href="/static/images/logo.png">
	
	<title>ä½¿ç”¨glusterfsåšæŒä¹…åŒ–å­˜å‚¨ | DreamAsHourse</title>
	
	

	<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ä½¿ç”¨glusterfsåšæŒä¹…åŒ–å­˜å‚¨"/>
<meta name="twitter:description" content="å®‰è£…glusterfs æˆ‘ä»¬ç›´æ¥åœ¨ç‰©ç†æœºä¸Šä½¿ç”¨yumå®‰è£…ï¼Œå¦‚æœä½ é€‰æ‹©åœ¨kubernetesä¸Šå®‰è£…ï¼Œè¯·å‚è€ƒï¼šhttps://github."/>

	<meta property="og:title" content="ä½¿ç”¨glusterfsåšæŒä¹…åŒ–å­˜å‚¨" />
<meta property="og:description" content="å®‰è£…glusterfs æˆ‘ä»¬ç›´æ¥åœ¨ç‰©ç†æœºä¸Šä½¿ç”¨yumå®‰è£…ï¼Œå¦‚æœä½ é€‰æ‹©åœ¨kubernetesä¸Šå®‰è£…ï¼Œè¯·å‚è€ƒï¼šhttps://github." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://magicletters.github.io/posts/%E4%BD%BF%E7%94%A8glusterfs%E5%81%9A%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8/" />
<meta property="article:published_time" content="2020-07-15T10:58:46+00:00" />
<meta property="article:modified_time" content="2020-07-15T10:58:46+00:00" />


	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp"
	 crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
	<link href="/css/medium.css" rel="stylesheet">
	<link href="/css/additional.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">
    <div class="container pr-0">
        
        <a class="navbar-brand" href="https://magicletters.github.io//">

            
            <img src="/static/images/logo.png" alt="logo">
            
        </a>
        

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        
        <div class="collapse navbar-collapse" id="navbarMediumish">
            
            <ul class="navbar-nav ml-auto">
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/posts">Posts</a>
                </li>
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/categories">Categories</a>
                </li>
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/tags">Tags</a>
                </li>
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/">About Me</a>
                </li>
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/static/imprint">Imprint</a>
                </li>
                
            </ul>
        </div>
        
    </div>
</nav>


        <div class="site-content">   
            <div class="container">
<div class="mainheading">
    <h1 class="sitetitle">DreamAsHourse</h1>
    <p class="lead">
         ä»¥æ¢¦ä¸ºé©¬ğŸ‡
    </p>
</div><div class="main-content">
        
        <div class="container">
            <div class="row">
                
                <div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset">
    <p>Share</p>
    <ul>
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://twitter.com/intent/tweet?text=%e4%bd%bf%e7%94%a8glusterfs%e5%81%9a%e6%8c%81%e4%b9%85%e5%8c%96%e5%ad%98%e5%82%a8&url=https%3a%2f%2fmagicletters.github.io%2fposts%2f%25E4%25BD%25BF%25E7%2594%25A8glusterfs%25E5%2581%259A%25E6%258C%2581%25E4%25B9%2585%25E5%258C%2596%25E5%25AD%2598%25E5%2582%25A8%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=435');return false;">
        <i class="fab fa-twitter"></i>
        </a>
        </li>
        
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://facebook.com/sharer.php?u=https%3a%2f%2fmagicletters.github.io%2fposts%2f%25E4%25BD%25BF%25E7%2594%25A8glusterfs%25E5%2581%259A%25E6%258C%2581%25E4%25B9%2585%25E5%258C%2596%25E5%25AD%2598%25E5%2582%25A8%2f" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
        <i class="fab fa-facebook-f"></i>
        </a>
        </li>

        <li class="ml-1 mr-1">
        <a target="_blank" href="https://www.xing.com/spi/shares/new?url=https%3a%2f%2fmagicletters.github.io%2fposts%2f%25E4%25BD%25BF%25E7%2594%25A8glusterfs%25E5%2581%259A%25E6%258C%2581%25E4%25B9%2585%25E5%258C%2596%25E5%25AD%2598%25E5%2582%25A8%2f" onclick="window.open(this.href, 'xing-share', 'width=550,height=435');return false;">
        <i class="fab fa-xing"></i>
        </a>
        </li>        
    </ul>

    
</div>
</div>
                                
                <div class="col-md-9 flex-first flex-md-unordered">
                    <div class="mainheading">
                        	
                        
                        
                        
                        <div class="row post-top-meta">
                            <div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0 md-nopad-right">
                                <img class="author-thumb" src="/static/images/author.png" alt="Zhu Jia">
                            </div>
                            <div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left md-nopad-left">
                                <a target="_blank" class="link-dark">Zhu Jia</a><br>
                                <span class="author-description">
                                    ä»¥æ¢¦ä¸ºé©¬<br>
                                    <i class="far fa-star"></i>
                                    Jul 15, 2020
                                    <i class="far fa-clock clock"></i>
                                    4 min read
                                </span>					
                            </div>
                        </div>			
                        	
                        
                                                
                        
                        <h1 class="posttitle">ä½¿ç”¨glusterfsåšæŒä¹…åŒ–å­˜å‚¨</h1> 
                    </div>

                    
                    
                    
                    

                    
                    <div class="article-post">
                        <h2 id="å®‰è£…glusterfs">å®‰è£…glusterfs</h2>
<p>æˆ‘ä»¬ç›´æ¥åœ¨ç‰©ç†æœºä¸Šä½¿ç”¨yumå®‰è£…ï¼Œå¦‚æœä½ é€‰æ‹©åœ¨kubernetesä¸Šå®‰è£…ï¼Œè¯·å‚è€ƒï¼šhttps://github.com/gluster/gluster-kubernetes/blob/master/docs/setup-guide.md</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># å…ˆå®‰è£… gluster æº</span>
$ yum install centos-release-gluster -y

<span style="color:#75715e"># å®‰è£… glusterfs ç»„ä»¶</span>
$ yum install -y glusterfs glusterfs-server glusterfs-fuse glusterfs-rdma glusterfs-geo-replication glusterfs-devel

<span style="color:#75715e"># ä»¥ä¸‹ä¸¤æ­¥æ ¹æ®å®é™…ç³»ç»Ÿèµ„æºåˆ†é…æ‰§è¡Œ</span>
<span style="color:#75715e">## åˆ›å»º glusterfs ç›®å½•</span>
$ mkdir /opt/glusterd

<span style="color:#75715e">## ä¿®æ”¹ glusterd ç›®å½•</span>
$ sed -i <span style="color:#e6db74">&#39;s/var\/lib/opt/g&#39;</span> /etc/glusterfs/glusterd.vol

<span style="color:#75715e"># å¯åŠ¨ glusterfs</span>
$ systemctl start glusterd.service

<span style="color:#75715e"># è®¾ç½®å¼€æœºå¯åŠ¨</span>
$ systemctl enable glusterd.service

<span style="color:#75715e">#æŸ¥çœ‹çŠ¶æ€</span>
$ systemctl status glusterd.service
</code></pre></div><h2 id="é…ç½®-glusterfs">é…ç½® glusterfs</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># é…ç½® hosts</span>

$ echo <span style="color:#e6db74">&#39;192.168.11.11   k8s-master
</span><span style="color:#e6db74">&gt; 192.168.11.12   work-node1
</span><span style="color:#e6db74">&gt; 192.168.11.13   work-node2
</span><span style="color:#e6db74">&gt; 192.168.11.14   work-node3
</span><span style="color:#e6db74">&gt; 192.168.11.15   work-node4&#39;</span> &gt;&gt; /etc/hosts
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># å¼€æ”¾ç«¯å£(å»ºè®®å…³é—­æœåŠ¡å™¨é˜²ç«å¢™: systemctl disable --now firewalld)</span>
$ iptables -I INPUT -p tcp --dport <span style="color:#ae81ff">24007</span> -j ACCEPT

<span style="color:#75715e"># åˆ›å»ºå­˜å‚¨ç›®å½•</span>
$ mkdir /opt/gfs_data
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># æ·»åŠ èŠ‚ç‚¹åˆ° é›†ç¾¤</span>
<span style="color:#75715e"># æ‰§è¡Œæ“ä½œçš„æœ¬æœºä¸éœ€è¦probe æœ¬æœº</span>
<span style="color:#f92672">[</span>root@k8s-master ~<span style="color:#f92672">]</span>#
gluster peer probe work-node1
gluster peer probe work-node2
gluster peer probe work-node3
gluster peer probe work-node4

<span style="color:#75715e"># æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</span>
$ gluster peer status
Number of Peers: <span style="color:#ae81ff">4</span>

Hostname: work-node1
Uuid: 6106a8b9-d8df-4ac9-9046-cdd5f2aa1f38
State: Peer in Cluster <span style="color:#f92672">(</span>Connected<span style="color:#f92672">)</span>

Hostname: work-node2
Uuid: e3675881-b0c7-48ef-a145-55ac62c2d1c2
State: Peer in Cluster <span style="color:#f92672">(</span>Connected<span style="color:#f92672">)</span>

Hostname: work-node3
Uuid: 30f2cf9a-3cb9-4a13-9d8e-8cfc7039d698
State: Peer in Cluster <span style="color:#f92672">(</span>Connected<span style="color:#f92672">)</span>

Hostname: work-node4
Uuid: c2d678fb-e5e6-4932-9ff0-1716f43aedd3
State: Peer in Cluster <span style="color:#f92672">(</span>Connected<span style="color:#f92672">)</span>

</code></pre></div><h2 id="é…ç½®-volume">é…ç½® volume</h2>
<p>GlusterFSä¸­çš„volumeçš„æ¨¡å¼æœ‰å¾ˆå¤šä¸­ï¼ŒåŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li><strong>åˆ†å¸ƒå·ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰</strong>ï¼šå³DHT, ä¹Ÿå« åˆ†å¸ƒå·: å°†æ–‡ä»¶ä»¥hashç®—æ³•éšæœºåˆ†å¸ƒåˆ° ä¸€å°æœåŠ¡å™¨èŠ‚ç‚¹ä¸­å­˜å‚¨ã€‚</li>
<li><strong>å¤åˆ¶æ¨¡å¼</strong>ï¼šå³AFR, åˆ›å»ºvolume æ—¶å¸¦ replica x æ•°é‡: å°†æ–‡ä»¶å¤åˆ¶åˆ° replica x ä¸ªèŠ‚ç‚¹ä¸­ã€‚</li>
<li><strong>æ¡å¸¦æ¨¡å¼</strong>ï¼šå³Striped, åˆ›å»ºvolume æ—¶å¸¦ stripe x æ•°é‡ï¼š å°†æ–‡ä»¶åˆ‡å‰²æˆæ•°æ®å—ï¼Œåˆ†åˆ«å­˜å‚¨åˆ° stripe x ä¸ªèŠ‚ç‚¹ä¸­ ( ç±»ä¼¼raid 0 )ã€‚</li>
<li><strong>åˆ†å¸ƒå¼æ¡å¸¦æ¨¡å¼</strong>ï¼šæœ€å°‘éœ€è¦4å°æœåŠ¡å™¨æ‰èƒ½åˆ›å»ºã€‚ åˆ›å»ºvolume æ—¶ stripe 2 server = 4 ä¸ªèŠ‚ç‚¹ï¼š æ˜¯DHT ä¸ Striped çš„ç»„åˆå‹ã€‚</li>
<li><strong>åˆ†å¸ƒå¼å¤åˆ¶æ¨¡å¼</strong>ï¼šæœ€å°‘éœ€è¦4å°æœåŠ¡å™¨æ‰èƒ½åˆ›å»ºã€‚ åˆ›å»ºvolume æ—¶ replica 2 server = 4 ä¸ªèŠ‚ç‚¹ï¼šæ˜¯DHT ä¸ AFR çš„ç»„åˆå‹ã€‚</li>
<li><strong>æ¡å¸¦å¤åˆ¶å·æ¨¡å¼</strong>ï¼šæœ€å°‘éœ€è¦4å°æœåŠ¡å™¨æ‰èƒ½åˆ›å»ºã€‚ åˆ›å»ºvolume æ—¶ stripe 2 replica 2 server = 4 ä¸ªèŠ‚ç‚¹ï¼š æ˜¯ Striped ä¸ AFR çš„ç»„åˆå‹ã€‚</li>
<li><strong>ä¸‰ç§æ¨¡å¼æ··åˆ</strong>ï¼š è‡³å°‘éœ€è¦8å° æœåŠ¡å™¨æ‰èƒ½åˆ›å»ºã€‚ stripe 2 replica 2 , æ¯4ä¸ªèŠ‚ç‚¹ ç»„æˆä¸€ä¸ª ç»„ã€‚</li>
</ul>
<p>è¿™å‡ ç§æ¨¡å¼çš„ç¤ºä¾‹å›¾å‚è€ƒï¼š<a href="http://www.cnblogs.com/jicki/p/5801712.html">CentOS7å®‰è£…GlusterFS</a>ã€‚</p>
<p>åœ¨æ­¤æˆ‘ä»¬ä½¿ç”¨é»˜è®¤çš„<strong>åˆ†å¸ƒå·æ¨¡å¼</strong>ã€‚<strong>è¯·å‹¿åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šä½¿ç”¨è¯¥æ¨¡å¼ï¼Œå®¹æ˜“å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># åˆ›å»ºåˆ†å¸ƒå·</span>
$ gluster volume create k8s-volume transport tcp k8s-master:/data/k8svol work-node1:/data/k8svol work-node2:/data/k8svol work-node3:/data/k8svol work-node4:/data/k8svol force

<span style="color:#75715e"># æŸ¥çœ‹volumeçŠ¶æ€</span>
$ gluster volume info
 
Volume Name: k8s-volume
Type: Distribute
Volume ID: deb413e6-19bf-4946-b40c-a3fe44feb26b
Status: Created
Snapshot Count: <span style="color:#ae81ff">0</span>
Number of Bricks: <span style="color:#ae81ff">5</span>
Transport-type: tcp
Bricks:
Brick1: k8s-master:/data/k8svol
Brick2: work-node1:/data/k8svol
Brick3: work-node2:/data/k8svol
Brick4: work-node3:/data/k8svol
Brick5: work-node4:/data/k8svol
Options Reconfigured:
transport.address-family: inet
storage.fips-mode-rchecksum: on
nfs.disable: on


<span style="color:#75715e"># å¯åŠ¨ åˆ†å¸ƒå·</span>
$ gluster volume start k8s-volume
</code></pre></div><h2 id="glusterfsè°ƒä¼˜">Glusterfsè°ƒä¼˜</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># å¼€å¯ æŒ‡å®š volume çš„é…é¢</span>
$ gluster volume quota k8s-volume enable

<span style="color:#75715e"># é™åˆ¶ æŒ‡å®š volume çš„é…é¢</span>
$ gluster volume quota k8s-volume limit-usage / 1TB

<span style="color:#75715e"># è®¾ç½® cache å¤§å°, é»˜è®¤32MB</span>
$ gluster volume set k8s-volume performance.cache-size 4GB

<span style="color:#75715e"># è®¾ç½® io çº¿ç¨‹, å¤ªå¤§ä¼šå¯¼è‡´è¿›ç¨‹å´©æºƒ</span>
$ gluster volume set k8s-volume performance.io-thread-count <span style="color:#ae81ff">16</span>

<span style="color:#75715e"># è®¾ç½® ç½‘ç»œæ£€æµ‹æ—¶é—´, é»˜è®¤42s</span>
$ gluster volume set k8s-volume network.ping-timeout <span style="color:#ae81ff">10</span>

<span style="color:#75715e"># è®¾ç½® å†™ç¼“å†²åŒºçš„å¤§å°, é»˜è®¤1M</span>
$ gluster volume set k8s-volume performance.write-behind-window-size 1024MB
</code></pre></div><h2 id="kubernetesä¸­é…ç½®glusterfs">Kubernetesä¸­é…ç½®glusterfs</h2>
<p>ä»¥ä¸‹ç”¨åˆ°çš„æ‰€æœ‰yamlå’Œjsoné…ç½®æ–‡ä»¶å¯ä»¥åœ¨<a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/manifests/glusterfs">../manifests/glusterfs</a>ä¸­æ‰¾åˆ°ã€‚æ³¨æ„æ›¿æ¢å…¶ä¸­ç§æœ‰é•œåƒåœ°å€ä¸ºä½ è‡ªå·±çš„é•œåƒåœ°å€ã€‚</p>
<h2 id="kuberneteså®‰è£…å®¢æˆ·ç«¯">kuberneteså®‰è£…å®¢æˆ·ç«¯</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># åœ¨æ‰€æœ‰ k8s node ä¸­å®‰è£… glusterfs å®¢æˆ·ç«¯</span>

$ yum install -y glusterfs glusterfs-fuse

<span style="color:#75715e"># é…ç½® hosts</span>

$ vi /etc/hosts

172.20.0.113   test-001.jimmysong.io
172.20.0.114   test-002.jimmysong.io
172.20.0.115   test-003.jimmysong.io
</code></pre></div><p>å› ä¸ºæˆ‘ä»¬glusterfsè·Ÿkubernetesé›†ç¾¤å¤ç”¨ä¸»æœºï¼Œå› ä¸ºæ­¤è¿™ä¸€æ­¥å¯ä»¥çœå»ã€‚</p>
<h2 id="é…ç½®-endpoints">é…ç½® endpoints</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl -O https://raw.githubusercontent.com/kubernetes/examples/master/volumes/glusterfs/glusterfs-endpoints.json

<span style="color:#75715e"># ä¿®æ”¹ endpoints.json ï¼Œé…ç½® glusters é›†ç¾¤èŠ‚ç‚¹ip</span>
<span style="color:#75715e"># æ¯ä¸€ä¸ª addresses ä¸ºä¸€ä¸ª ip ç»„</span>

    <span style="color:#f92672">{</span>
      <span style="color:#e6db74">&#34;addresses&#34;</span>: <span style="color:#f92672">[</span>
        <span style="color:#f92672">{</span>
          <span style="color:#e6db74">&#34;ip&#34;</span>: <span style="color:#e6db74">&#34;172.22.0.113&#34;</span>
        <span style="color:#f92672">}</span>
      <span style="color:#f92672">]</span>,
      <span style="color:#e6db74">&#34;ports&#34;</span>: <span style="color:#f92672">[</span>
        <span style="color:#f92672">{</span>
          <span style="color:#e6db74">&#34;port&#34;</span>: <span style="color:#ae81ff">1990</span>
        <span style="color:#f92672">}</span>
      <span style="color:#f92672">]</span>
    <span style="color:#f92672">}</span>,

<span style="color:#75715e"># å¯¼å…¥ glusterfs-endpoints.json</span>

$ kubectl apply -f glusterfs-endpoints.json

<span style="color:#75715e"># æŸ¥çœ‹ endpoints ä¿¡æ¯</span>
$ kubectl get ep
</code></pre></div><h2 id="é…ç½®-service">é…ç½® service</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl -O https://raw.githubusercontent.com/kubernetes/examples/master/volumes/glusterfs/glusterfs-service.json

<span style="color:#75715e"># service.json é‡Œé¢æŸ¥æ‰¾çš„æ˜¯ enpointes çš„åç§°ä¸ç«¯å£ï¼Œç«¯å£é»˜è®¤é…ç½®ä¸º 1ï¼Œæˆ‘æ”¹æˆäº†1990</span>

<span style="color:#75715e"># å¯¼å…¥ glusterfs-service.json</span>
$ kubectl apply -f glusterfs-service.json

<span style="color:#75715e"># æŸ¥çœ‹ service ä¿¡æ¯</span>
$ kubectl get svc
</code></pre></div><h2 id="åˆ›å»ºæµ‹è¯•-pod">åˆ›å»ºæµ‹è¯• pod</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl -O https://raw.githubusercontent.com/kubernetes/examples/master/volumes/glusterfs/glusterfs-pod.json

<span style="color:#75715e"># ç¼–è¾‘ glusterfs-pod.json</span>
<span style="color:#75715e"># ä¿®æ”¹ volumes  ä¸‹çš„ path ä¸ºä¸Šé¢åˆ›å»ºçš„ volume åç§°</span>

<span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;k8s-volume&#34;</span>

<span style="color:#75715e"># å¯¼å…¥ glusterfs-pod.json</span>
$ kubectl apply -f glusterfs-pod.json

<span style="color:#75715e"># æŸ¥çœ‹ pods çŠ¶æ€</span>
$ kubectl get pods               
NAME                             READY     STATUS    RESTARTS   AGE
glusterfs                        1/1       Running   <span style="color:#ae81ff">0</span>          1m

<span style="color:#75715e"># æŸ¥çœ‹ pods æ‰€åœ¨ node</span>
$ kubectl describe pods/glusterfs

<span style="color:#75715e"># ç™»é™† node ç‰©ç†æœºï¼Œä½¿ç”¨ df å¯æŸ¥çœ‹æŒ‚è½½ç›®å½•</span>
$ df -h
172.20.0.113:k8s-volume <span style="color:#ae81ff">1073741824</span>        <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1073741824</span>   0% 172.20.0.113:k8s-volume  1.0T     <span style="color:#ae81ff">0</span>  1.0T   0% /var/lib/kubelet/pods/3de9fc69-30b7-11e7-bfbd-8af1e3a7c5bd/volumes/kubernetes.io~glusterfs/glusterfsvol
</code></pre></div><h2 id="é…ç½®persistentvolume">é…ç½®PersistentVolume</h2>
<p>PersistentVolumeï¼ˆPVï¼‰å’Œ PersistentVolumeClaimï¼ˆPVCï¼‰æ˜¯kubernetesæä¾›çš„ä¸¤ç§APIèµ„æºï¼Œç”¨äºæŠ½è±¡å­˜å‚¨ç»†èŠ‚ã€‚ç®¡ç†å‘˜å…³æ³¨äºå¦‚ä½•é€šè¿‡pvæä¾›å­˜å‚¨åŠŸèƒ½è€Œæ— éœ€å…³æ³¨ç”¨æˆ·å¦‚ä½•ä½¿ç”¨ï¼ŒåŒæ ·çš„ç”¨æˆ·åªéœ€è¦æŒ‚è½½PVCåˆ°å®¹å™¨ä¸­è€Œä¸éœ€è¦å…³æ³¨å­˜å‚¨å·é‡‡ç”¨ä½•ç§æŠ€æœ¯å®ç°ã€‚</p>
<p>PVCå’ŒPVçš„å…³ç³»è·Ÿpodå’Œnodeå…³ç³»ç±»ä¼¼ï¼Œå‰è€…æ¶ˆè€—åè€…çš„èµ„æºã€‚PVCå¯ä»¥å‘PVç”³è¯·æŒ‡å®šå¤§å°çš„å­˜å‚¨èµ„æºå¹¶è®¾ç½®è®¿é—®æ¨¡å¼ã€‚</p>
<p>**PVå±æ€§ **</p>
<ul>
<li>storageå®¹é‡</li>
<li>è¯»å†™å±æ€§ï¼šåˆ†åˆ«ä¸ºReadWriteOnceï¼šå•ä¸ªèŠ‚ç‚¹è¯»å†™ï¼› ReadOnlyManyï¼šå¤šèŠ‚ç‚¹åªè¯» ï¼› ReadWriteManyï¼šå¤šèŠ‚ç‚¹è¯»å†™</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat glusterfs-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: gluster-dev-volume
spec:
  capacity:
    storage: 8Gi
  accessModes:
    - ReadWriteMany
  glusterfs:
    endpoints: <span style="color:#e6db74">&#34;glusterfs-cluster&#34;</span>
    path: <span style="color:#e6db74">&#34;k8s-volume&#34;</span>
    readOnly: false

<span style="color:#75715e"># å¯¼å…¥PV</span>
$ kubectl apply -f glusterfs-pv.yaml

<span style="color:#75715e"># æŸ¥çœ‹ pv</span>
$ kubectl get pv
NAME                 CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS      CLAIM     STORAGECLASS   REASON    AGE
gluster-dev-volume   8Gi        RWX           Retain          Available                                      3s
</code></pre></div><p>PVCå±æ€§</p>
<ul>
<li>è®¿é—®å±æ€§ä¸PVç›¸åŒ</li>
<li>å®¹é‡ï¼šå‘PVç”³è¯·çš„å®¹é‡ &lt;= PVæ€»å®¹é‡</li>
</ul>
<h2 id="é…ç½®pvc">é…ç½®PVC</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat glusterfs-pvc.yaml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: glusterfs-nginx
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 8Gi

<span style="color:#75715e"># å¯¼å…¥ pvc</span>
$ kubectl apply -f glusterfs-pvc.yaml

<span style="color:#75715e"># æŸ¥çœ‹ pvc</span>

$ kubectl get pv
NAME              STATUS    VOLUME               CAPACITY   ACCESSMODES   STORAGECLASS   AGE
glusterfs-nginx   Bound     gluster-dev-volume   8Gi        RWX                          4s
</code></pre></div><h2 id="åˆ›å»º-nginx-deployment-æŒ‚è½½-volume">åˆ›å»º nginx deployment æŒ‚è½½ volume</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vi nginx-deployment.yaml
apiVersion: extensions/v1beta1 
kind: Deployment 
metadata: 
  name: nginx-dm
spec: 
  replicas: <span style="color:#ae81ff">2</span>
  template: 
    metadata: 
      labels: 
        name: nginx 
    spec: 
      containers: 
        - name: nginx 
          image: nginx:alpine 
          imagePullPolicy: IfNotPresent
          ports: 
            - containerPort: <span style="color:#ae81ff">80</span>
          volumeMounts:
            - name: gluster-dev-volume
              mountPath: <span style="color:#e6db74">&#34;/usr/share/nginx/html&#34;</span>
      volumes:
      - name: gluster-dev-volume
        persistentVolumeClaim:
          claimName: glusterfs-nginx

<span style="color:#75715e"># å¯¼å…¥ deployment</span>
$ kubectl apply -f nginx-deployment.yaml 

<span style="color:#75715e"># æŸ¥çœ‹ deployment</span>
$ kubectl get pods |grep nginx-dm
nginx-dm-3698525684-g0mvt       1/1       Running   <span style="color:#ae81ff">0</span>          6s
nginx-dm-3698525684-hbzq1       1/1       Running   <span style="color:#ae81ff">0</span>          6s

<span style="color:#75715e"># æŸ¥çœ‹ æŒ‚è½½</span>
$ kubectl exec -it nginx-dm-3698525684-g0mvt -- df -h|grep k8s-volume
172.20.0.113:k8s-volume         1.0T     <span style="color:#ae81ff">0</span>  1.0T   0% /usr/share/nginx/html

<span style="color:#75715e"># åˆ›å»ºæ–‡ä»¶ æµ‹è¯•</span>
$ kubectl exec -it nginx-dm-3698525684-g0mvt -- touch /usr/share/nginx/html/index.html

$ kubectl exec -it nginx-dm-3698525684-g0mvt -- ls -lt /usr/share/nginx/html/index.html
-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">0</span> May  <span style="color:#ae81ff">4</span> 11:36 /usr/share/nginx/html/index.html

<span style="color:#75715e"># éªŒè¯ glusterfs</span>
<span style="color:#75715e"># å› ä¸ºæˆ‘ä»¬ä½¿ç”¨åˆ†å¸ƒå·ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°æŸä¸ªèŠ‚ç‚¹ä¸­æœ‰æ–‡ä»¶</span>
<span style="color:#f92672">[</span>root@test-001 ~<span style="color:#f92672">]</span> ls /opt/gfs_data/
<span style="color:#f92672">[</span>root@test-002 ~<span style="color:#f92672">]</span> ls /opt/gfs_data/
index.html
<span style="color:#f92672">[</span>root@test-003 ~<span style="color:#f92672">]</span> ls /opt/gfs_data/
</code></pre></div><h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="http://www.cnblogs.com/jicki/p/5801712.html">CentOS 7 å®‰è£… GlusterFS</a></li>
</ul>

                    </div>
                    
                    
                    <div class="after-post-tags">
                        <ul class="tags">
                        
                        <li>
                        <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8">åˆ†å¸ƒå¼å­˜å‚¨</a>
                        </li>
                        
                        </ul>
                    </div>
                    
                    
                    
                    <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
                    
                        <a class="d-block col-md-6" href="https://magicletters.github.io/posts/adoc/asciidoctor%E7%94%9F%E6%88%90%E5%8C%85%E5%90%AB%E4%B8%AD%E6%96%87%E7%9A%84pdf/"> &laquo; asciidoctorç”ŸæˆåŒ…å«ä¸­æ–‡çš„pdf</a>
                    
                    
                        <a class="d-block col-md-6 text-lg-right" href="https://magicletters.github.io/posts/glusterfs%E7%9A%84%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">Glusterfsçš„å¸¸ç”¨å‘½ä»¤ &raquo;</a>
                    
                    <div class="clearfix"></div>
                    </div>
                    
                </div>
                
            </div>
        </div>
        
        
    </div>


            </div>
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
			<div class="d-md-flex align-items-center justify-content-center h-100">
				<h2 class="d-md-block d-none align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">â†’</span></h2>
			</div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
			
			<a class="mt-1 mb-1" href="/tags/adoc">adoc</a>
			
			<a class="mt-1 mb-1" href="/tags/arm">arm</a>
			
			<a class="mt-1 mb-1" href="/tags/clion">clion</a>
			
			<a class="mt-1 mb-1" href="/tags/cpp">cpp</a>
			
			<a class="mt-1 mb-1" href="/tags/docker">docker</a>
			
			<a class="mt-1 mb-1" href="/tags/golang">golang</a>
			
			<a class="mt-1 mb-1" href="/tags/ide">ide</a>
			
			<a class="mt-1 mb-1" href="/tags/java">java</a>
			
			<a class="mt-1 mb-1" href="/tags/k8s">k8s</a>
			
			<a class="mt-1 mb-1" href="/tags/raft">raft</a>
			
			<a class="mt-1 mb-1" href="/tags/shell">shell</a>
			
			<a class="mt-1 mb-1" href="/tags/spring">spring</a>
			
			<a class="mt-1 mb-1" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8">åˆ†å¸ƒå¼å­˜å‚¨</a>
			
			<a class="mt-1 mb-1" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">è®¾è®¡æ¨¡å¼</a>
			
		</div>
	</div>
</div>

<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                &copy; Copyright Zhu Jia - All rights reserved
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a target="_blank" rel="noopener" href="https://www.wowthemes.net">Mediumish Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>


        </div>


<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<script src="/js/mediumish.js"></script>

    </body>
</html>
